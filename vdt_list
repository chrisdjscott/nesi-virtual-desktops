#!/bin/bash

# Lists named singularity instance.
# Author: Callum
# https://github.com/nesi/nesi-virtual-desktops

root="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
export VDT_LOCKFILES=${VDT_LOCKFILES:-"$root/lockfiles"}

module purge > /dev/null  2>&1
module load Python Singularity/3.5.2 -q 
module unload XALT/NeSI -q



# Where files are saved in user home.
help() {
cat << EndOfHelp
[1mNAME[0m
        $(basename "$0") - List virtual desktops.

[1mSYNOPSIS[0m
        $(basename "$0") [-h ] < display-port >

[1mDESCRIPTION[0m
        Lists VNC sessions

[1mPARAMETERS[0m

    -n --noheader           Print without header.

    -h --help               This is help.

EndOfHelp
}

parse_input() {
    while [[ $# -gt 0 ]];do
        case $1 in
            -n|--noheader)
                noheader="true"
                shift
            ;;
            -h|--help)
                help "$0"
                exit 0
                shift
            ;;
            *)
                echo $@
                echo "Unknown option '${1}', -h for help."  >&2
                help "$0"
                exit 1
            ;;
        esac
    done
}

list_vnc(){

    #$echo $vnc_pid_root
    #if [["$verbose"]]; then echo "Using "
    _uniq_hosts=()
    _intances=()
    _lockfiles=($(ls $VDT_LOCKFILES))


    #vnc_list=( $(ls "${vnc_pid_root:="${HOME}/.vnc"}"/*.pid 2> /dev/null || true) )
    #echo "${vnc_list[@]}"
    for session in  ${_lockfiles[@]} ; do
        #echo $session
        #_display_port=$(echo "${session}" | sed -e 's/.*:\([0-9]*\).pid/\1/')
        #_hostname=$(echo "$session" | sed -e 's/.*\/\(.*\):.*/\1/')
        
        _uniq_hosts+=( "$(echo $session | cut -d "." -f2)" )
        #echo "${_display_port} ${_hostname}"    
        #echo "${session}"  	

    done
    _uniq_hosts=($(printf "%s\n" "${_uniq_hosts[@]}" | sort -u | tr '\n' ' '))
    #_intances+=( $(singularity instance list | tail -n +2 | tr -s " " "\|" | tr '\n' '${HOSTNAME} \n' &) )
    if [[ ! "$noheader" ]]; then printf "%12s %12s %12s %20s\n" "Name" "PID" "Host" "Image";fi

    singularity instance list | tail -n +2 |awk -v host="$(hostname)" '{printf "%12s %12s %12s %20s\n", $1, $2, host, $3}'

    for host in "${_uniq_hosts[@]}" ; do
        if [[ "${host}" == "$(hostname)" ]];then continue; fi
        echo "HOSTNAME='$host'"
        ssh -q ${host} "module load "Singularity/${EBVERSIONSINGULARITY}";singularity instance list | tail -n +2 |awk -v host="$(hostname)" '{printf "%12s %12s %12s %20s\n", $1, $2, host, $3}'" || find ${VDT_LOCKFILES}/*.${host} -user ${USER} -exec rm -f {} \; &2>/dev/null
    done
    
    #printf "${_intances[@]}"

    
exit 0
}

main() {
    parse_input "$@"
    list_vnc
}

main "$@"

